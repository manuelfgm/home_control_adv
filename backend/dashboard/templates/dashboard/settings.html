{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}Configuración - Home Control{% endblock %}

{% block extra_css %}
<style>
    .settings-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .settings-section h3 {
        color: #2c3e50;
        margin-bottom: 1rem;
        border-bottom: 2px solid #3498db;
        padding-bottom: 0.5rem;
    }
    
    .temperature-control {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin: 1rem 0;
    }
    
    .temperature-input {
        width: 80px;
        text-align: center;
        font-size: 1.2rem;
        padding: 0.5rem;
        border: 2px solid #ddd;
        border-radius: 4px;
    }
    
    .btn-save {
        background: #27ae60;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
    }
    
    .btn-save:hover {
        background: #219a52;
    }
    
    .alert {
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 4px;
        display: none;
    }
    
    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <h1 class="text-center mb-4">
                <i class="fas fa-cog"></i> Configuración del Sistema
            </h1>
            
            <!-- Alertas -->
            <div id="alert-success" class="alert alert-success" role="alert">
                <i class="fas fa-check-circle"></i> <span id="success-message"></span>
            </div>
            
            <div id="alert-error" class="alert alert-error" role="alert">
                <i class="fas fa-exclamation-triangle"></i> <span id="error-message"></span>
            </div>
            
            <!-- Configuración de Temperatura -->
            <div class="settings-card">
                <div class="settings-section">
                    <h3><i class="fas fa-thermometer-half"></i> Temperatura Mínima</h3>
                    <p class="text-muted">
                        Esta es la temperatura que se mantendrá cuando no haya ningún horario activo.
                    </p>
                    
                    <div class="temperature-control">
                        <label for="minimum-temp">Temperatura mínima:</label>
                        <input type="number" 
                               id="minimum-temp" 
                               class="temperature-input" 
                               min="5" 
                               max="25" 
                               step="0.5" 
                               value="16.0">
                        <span>°C</span>
                        <button id="save-temp" class="btn-save">
                            <i class="fas fa-save"></i> Guardar
                        </button>
                    </div>
                    
                    <div class="mt-3">
                        <h4>Estado Actual</h4>
                        <div id="current-status" class="d-flex align-items-center gap-3">
                            <div class="status-item">
                                <strong>Temperatura actual:</strong> 
                                <span id="current-temp">--</span>°C
                            </div>
                            <div class="status-item">
                                <strong>Temperatura objetivo:</strong> 
                                <span id="target-temp">--</span>°C
                            </div>
                            <div class="status-item">
                                <strong>Estado:</strong> 
                                <span id="heating-status" class="badge">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Configuración de Histéresis -->
            <div class="settings-card">
                <div class="settings-section">
                    <h3><i class="fas fa-adjust"></i> Histéresis</h3>
                    <p class="text-muted">
                        Diferencia de temperatura para evitar encendido/apagado frecuente.
                    </p>
                    
                    <div class="temperature-control">
                        <label for="hysteresis">Histéresis:</label>
                        <input type="number" 
                               id="hysteresis" 
                               class="temperature-input" 
                               min="0.1" 
                               max="2.0" 
                               step="0.1" 
                               value="0.5">
                        <span>°C</span>
                        <button id="save-hysteresis" class="btn-save">
                            <i class="fas fa-save"></i> Guardar
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Enlaces a otras secciones -->
            <div class="settings-card">
                <div class="settings-section">
                    <h3><i class="fas fa-clock"></i> Horarios</h3>
                    <p class="text-muted">
                        Gestiona los horarios de calefacción programados.
                    </p>
                    <a href="{% url 'dashboard:schedules' %}" class="btn btn-primary">
                        <i class="fas fa-calendar-alt"></i> Gestionar Horarios
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Cargar configuración actual
    loadCurrentSettings();
    loadSystemStatus();
    
    // Eventos
    document.getElementById('save-temp').addEventListener('click', saveMinimumTemperature);
    document.getElementById('save-hysteresis').addEventListener('click', saveHysteresis);
    
    // Actualizar estado cada 30 segundos
    setInterval(loadSystemStatus, 30000);
});

function showAlert(type, message) {
    const alertElement = document.getElementById(`alert-${type}`);
    const messageElement = document.getElementById(`${type}-message`);
    
    messageElement.textContent = message;
    alertElement.style.display = 'block';
    
    setTimeout(() => {
        alertElement.style.display = 'none';
    }, 5000);
}

function loadCurrentSettings() {
    fetch('/heating/api/settings/current/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('minimum-temp').value = data.minimum_temperature;
            document.getElementById('hysteresis').value = data.hysteresis;
        })
        .catch(error => {
            console.error('Error loading settings:', error);
        });
}

function loadSystemStatus() {
    fetch('/heating/api/control/status/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('current-temp').textContent = 
                data.control.current_temperature || '--';
            document.getElementById('target-temp').textContent = 
                data.target_temperature || '--';
            
            const statusElement = document.getElementById('heating-status');
            if (data.control.is_heating) {
                statusElement.textContent = 'Encendida';
                statusElement.className = 'badge bg-danger';
            } else {
                statusElement.textContent = 'Apagada';
                statusElement.className = 'badge bg-secondary';
            }
        })
        .catch(error => {
            console.error('Error loading status:', error);
        });
}

function saveMinimumTemperature() {
    const temperature = parseFloat(document.getElementById('minimum-temp').value);
    
    if (isNaN(temperature) || temperature < 5 || temperature > 25) {
        showAlert('error', 'La temperatura debe estar entre 5°C y 25°C');
        return;
    }
    
    fetch('/heating/api/settings/update_minimum_temperature/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            minimum_temperature: temperature
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showAlert('success', data.message);
            loadSystemStatus(); // Actualizar estado
        } else if (data.error) {
            showAlert('error', data.error);
        }
    })
    .catch(error => {
        console.error('Error saving temperature:', error);
        showAlert('error', 'Error al guardar la configuración');
    });
}

function saveHysteresis() {
    const hysteresis = parseFloat(document.getElementById('hysteresis').value);
    
    if (isNaN(hysteresis) || hysteresis < 0.1 || hysteresis > 2.0) {
        showAlert('error', 'La histéresis debe estar entre 0.1°C y 2.0°C');
        return;
    }
    
    // Implementar API para actualizar histéresis
    showAlert('success', 'Histéresis actualizada (función pendiente de implementar)');
}

function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}
</script>
{% endblock %}