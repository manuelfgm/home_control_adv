{% extends "dashboard/base.html" %}

{% block title %}Dashboard - Control de Calefacción{% endblock %}

{% block content %}
<div class="row">
    <!-- Estado de Sensores -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-thermometer-half"></i> Estado de Sensores</h5>
            </div>
            <div class="card-body" id="sensors-container">
                <!-- Se carga via JavaScript -->
            </div>
        </div>
    </div>

    <!-- Estado de Calefacción -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-fire"></i> Estado de Calefacción</h5>
            </div>
            <div class="card-body" id="heating-container">
                <!-- Se carga via JavaScript -->
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Gráfico de Temperatura -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-chart-line"></i> Temperatura (Últimas 24h)</h5>
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="timeRange" id="range6h" value="6">
                    <label class="btn btn-outline-primary btn-sm" for="range6h">6h</label>
                    
                    <input type="radio" class="btn-check" name="timeRange" id="range24h" value="24" checked>
                    <label class="btn btn-outline-primary btn-sm" for="range24h">24h</label>
                    
                    <input type="radio" class="btn-check" name="timeRange" id="range7d" value="168">
                    <label class="btn btn-outline-primary btn-sm" for="range7d">7d</label>
                </div>
            </div>
            <div class="card-body">
                <canvas id="temperatureChart" height="100"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Horario Actual -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-clock"></i> Horario Actual</h5>
            </div>
            <div class="card-body" id="schedule-container">
                <!-- Se carga via JavaScript -->
            </div>
        </div>
    </div>

    <!-- Control Rápido -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> Control Rápido</h5>
            </div>
            <div class="card-body" id="quick-control-container">
                <div class="d-grid gap-2">
                    <button class="btn btn-danger" onclick="manualControl('turn_off', null, 30)">
                        <i class="fas fa-stop"></i> Apagar 30min
                    </button>
                    <button class="btn btn-success" onclick="manualControl('turn_on', null, 60)">
                        <i class="fas fa-play"></i> Encender 1h
                    </button>
                    <button class="btn btn-warning" onclick="manualControl('clear_override')">
                        <i class="fas fa-undo"></i> Modo Automático
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let temperatureChart = null;
    let refreshInterval = null;

    // Inicializar dashboard
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
        initializeChart();
        
        // Refrescar cada 30 segundos
        refreshInterval = setInterval(loadDashboardData, 30000);
        
        // Event listeners para cambios de rango de tiempo
        document.querySelectorAll('input[name="timeRange"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    loadTemperatureChart(parseInt(this.value));
                }
            });
        });
    });

    // Cargar datos principales del dashboard
    async function loadDashboardData() {
        showLoading();
        
        try {
            const response = await fetch('/dashboard/api/status/', {
                headers: defaultHeaders
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            renderSensors(data.sensors);
            renderHeating(data.heating);
            renderCurrentSchedule(data.current_schedule);
            
            hideLoading();
            updateTimestamps();
            
        } catch (error) {
            console.error('Error loading dashboard data:', error);
            showError('sensors-container', error.message);
            showError('heating-container', error.message);
            hideLoading();
        }
    }

    // Renderizar estado de sensores
    function renderSensors(sensors) {
        const container = document.getElementById('sensors-container');
        
        if (!sensors || sensors.length === 0) {
            container.innerHTML = '<p class="text-muted">No hay sensores configurados</p>';
            return;
        }

        let html = '';
        sensors.forEach(sensor => {
            const statusClass = sensor.is_online ? 'status-online' : 'status-offline';
            const statusIcon = sensor.is_online ? 'fa-check-circle' : 'fa-times-circle';
            
            html += `
                <div class="mb-3 p-3 border rounded">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-1">${sensor.name || sensor.id}</h6>
                        <span class="${statusClass}">
                            <i class="fas ${statusIcon}"></i>
                        </span>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Temperatura</small>
                            <div class="h5">${sensor.temperature ? sensor.temperature + '°C' : 'N/A'}</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Humedad</small>
                            <div class="h5">${sensor.humidity ? sensor.humidity + '%' : 'N/A'}</div>
                        </div>
                    </div>
                    <small class="text-muted">
                        <i class="fas fa-clock"></i> ${timeAgo(sensor.temp_timestamp)}
                    </small>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    // Renderizar estado de calefacción
    function renderHeating(heating) {
        const container = document.getElementById('heating-container');
        
        if (!heating) {
            container.innerHTML = '<p class="text-muted">No hay datos de calefacción</p>';
            return;
        }

        const statusClass = heating.is_heating ? 'heating-on' : 'heating-off';
        const statusIcon = heating.is_heating ? 'fa-fire' : 'fa-snowflake';
        const statusText = heating.is_heating ? 'ENCENDIDA' : 'APAGADA';
        
        const html = `
            <div class="text-center p-3 rounded ${statusClass}">
                <div class="h2 mb-3">
                    <i class="fas ${statusIcon}"></i>
                </div>
                <div class="h4 mb-2">${statusText}</div>
                <div class="row">
                    <div class="col-6">
                        <small>Actual</small>
                        <div class="h5">${heating.current_temperature || 'N/A'}°C</div>
                    </div>
                    <div class="col-6">
                        <small>Objetivo</small>
                        <div class="h5">${heating.target_temperature || 'N/A'}°C</div>
                    </div>
                </div>
                ${heating.is_manual_override ? 
                    '<div class="mt-2"><small><i class="fas fa-hand-paper"></i> Control Manual</small></div>' : ''
                }
            </div>
        `;
        
        container.innerHTML = html;
    }

    // Renderizar horario actual
    function renderCurrentSchedule(schedule) {
        const container = document.getElementById('schedule-container');
        
        if (!schedule) {
            container.innerHTML = '<p class="text-muted">No hay horario activo</p>';
            return;
        }

        const html = `
            <div class="p-3 bg-light rounded">
                <h6 class="mb-2">${schedule.name}</h6>
                <div class="row">
                    <div class="col-6">
                        <small class="text-muted">Horario</small>
                        <div>${schedule.start_time} - ${schedule.end_time}</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Temperatura</small>
                        <div class="h5 text-primary">${schedule.target_temperature}°C</div>
                    </div>
                </div>
            </div>
        `;
        
        container.innerHTML = html;
    }

    // Inicializar gráfico de temperatura
    function initializeChart() {
        const ctx = document.getElementById('temperatureChart').getContext('2d');
        
        temperatureChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Temperatura (°C)',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Temperatura (°C)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Hora'
                        }
                    }
                }
            }
        });
        
        // Cargar datos iniciales
        loadTemperatureChart(24);
    }

    // Cargar datos del gráfico de temperatura
    async function loadTemperatureChart(hours = 24) {
        try {
            const response = await fetch(`/dashboard/api/temperature-chart/?hours=${hours}`, {
                headers: defaultHeaders
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            temperatureChart.data.labels = data.labels;
            temperatureChart.data.datasets[0].data = data.datasets[0].data;
            temperatureChart.update();
            
        } catch (error) {
            console.error('Error loading temperature chart:', error);
            showAlert('Error al cargar el gráfico de temperatura', 'danger');
        }
    }

    // Control manual
    async function manualControl(action, temperature = null, duration = 60) {
        try {
            const requestData = {
                action: action,
                duration_minutes: duration
            };
            
            if (temperature) {
                requestData.temperature = temperature;
            }
            
            const response = await fetch('/dashboard/api/manual-control/', {
                method: 'POST',
                headers: defaultHeaders,
                body: JSON.stringify(requestData)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                showAlert(result.message, 'success');
                // Refrescar datos después de 2 segundos
                setTimeout(loadDashboardData, 2000);
            } else {
                showAlert(result.error || 'Error en el control manual', 'danger');
            }
            
        } catch (error) {
            console.error('Error in manual control:', error);
            showAlert('Error al ejecutar control manual', 'danger');
        }
    }

    // Limpiar intervalo al salir
    window.addEventListener('beforeunload', function() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
    });
</script>
{% endblock %}